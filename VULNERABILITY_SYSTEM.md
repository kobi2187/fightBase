# Vulnerability and Tactical System Implementation

## Overview

This document describes the new vulnerability targeting and tactical decision-making system added to the martial arts simulation engine.

## Key Additions

### 1. Vulnerability Points Database (`src/vulnerabilities.nim`)

**Purpose**: Maps all human body weak points with tactical data for realistic target selection.

**Features**:
- **28 vulnerability zones** from eyes to feet
- **Force requirements** - exact Newtons needed to affect each target
- **Reachability calculations** - distance from centerline, height level
- **Exposure by stance** - how exposed each target is per fighting stance
- **Effect data** - pain, structural impact, disabling potential, compliance rates

**Example Targets**:
```nim
vzEyes:          5N force,   0.9 exposure,  0.7 compliance
vzThroat:        20N force,  0.7 exposure,  0.99 compliance (extreme)
vzGroin:         10N force,  0.7 exposure,  1.0 compliance (fight over)
vzKneeLateral:   60N force,  0.9 exposure,  0.95 compliance (mobility kill)
vzLiver:         150N force, 0.6 exposure,  1.0 compliance (systemic shock)
```

**Key Functions**:
- `getVulnerabilityData(zone)` - Returns all tactical data for a zone
- `calculateReachability(attacker, defender, target, distance)` - 0.0-1.0 score
- `getBestTargets(attacker, defender, distance, preferLowExposure)` - Ranked list

### 2. General Move Categories (`src/fight_types.nim`)

**Refactored from specific techniques to GENERAL categories**:

```nim
MoveType (5 fundamental categories):
  - mtPositional   # Footwork, stances, angles
  - mtEvasion      # Slips, bobs, rolls
  - mtDeflection   # Parries, redirects (minimal force)
  - mtDefensive    # Blocks, covers, frames (structural)
  - mtOffensive    # All attacks

MoveCategory (30+ specific sub-types):
  Positional: mcStep, mcPivot, mcStanceChange, mcAngleChange, mcLevelChange
  Evasion: mcSlip, mcBob, mcRoll, mcPull
  Deflection: mcParry, mcCheck, mcRedirect, mcJam
  Defensive: mcBlock, mcCover, mcFrame
  Offensive: mcStraightStrike, mcArcStrike, mcWhipStrike, mcPushStrike,
             mcSweep, mcTrip, mcThrow, mcTakedown, mcClinchEntry,
             mcLock, mcChoke, mcTrap, mcCounter, mcFeint
```

**Move Object Enhancements**:
```nim
Move:
  moveType: MoveType            # General category
  category: MoveCategory        # Specific sub-category
  targets: seq[string]          # Vulnerability zones (for offensive)
  optionsCreated: int           # Tactical liquidity metric
  exposureRisk: float           # 0.0-1.0, how much this exposes you
```

### 3. Combination Rules for Plies (`src/moves.nim`)

**Problem Addressed**: "For each ply user can do several moves in different categories, but not all combinations work."

**Solution**: `canCombineMoveTypes()` function enforces realistic combinations:

**Allowed Per Ply**:
- ✅ Evasion + Deflection + Offensive (e.g., slip, parry, counter punch)
- ✅ Positional + Offensive (e.g., step forward + jab)
- ✅ Deflection + Positional + Offensive (e.g., parry, angle, hook)
- ✅ Up to 2 of each category type

**Prevented**:
- ❌ 3+ offensive moves in one ply (too committed)
- ❌ 3+ of any single type (unrealistic)

**Rules**:
```nim
mtPositional: max 2 per ply
mtEvasion: max 2 per ply
mtDeflection: max 2 per ply
mtDefensive: max 2 per ply
mtOffensive: max 2 per ply (most restrictive)
```

### 4. Tactical Decision System (`src/tactical.nim`)

**Purpose**: Score moves based on target quality, exposure, and option advantage.

**Key Functions**:

**`scoreMoveByTarget(move, attacker, defender, distance, preferLowExposure)`**
- Scores offensive moves by vulnerability effectiveness
- Considers: force required, reachability, compliance, disabling potential
- In tight spots (<0.5m), strongly prefers low-force targets
- Defensive mindset reduces exposure risk

**`calculateOptionAdvantage(state, who, viableMoves)`**
- Implements "tactical liquidity" concept from your design docs
- Ratio of our options vs opponent's estimated options
- Uses balance and fatigue as proxy for opponent's options

**`scoreMoveTactically(move, state, who, viableMoves)`**
- Complete tactical scoring
- Combines target selection + option advantage
- Penalizes high-exposure when already winning
- Rewards option-preserving moves

**Example Scoring**:
```
Straight strike to nose:
  Base score = compliance(0.8) / force(80N) = 0.01
  × reachability(0.85) = 0.0085
  × disabling bonus (none) = 0.0085
  × energy efficiency = 0.0085 * 0.9 = 0.00765
  × options created (10) = 0.0765

Groin strike at close range:
  Base score = compliance(1.0) / force(10N) = 0.1
  × reachability(0.7) = 0.07
  × disabling bonus (×2) = 0.14
  × systemic bonus (×1.5) = 0.21
  × close-range low-force bonus = 0.21 * (100/20) = 1.05
  >>> MUCH HIGHER SCORE in tight spots
```

### 5. General Moves Library (`src/general_moves.nim`)

**Replaced specific martial art techniques with biomechanical patterns**:

**Positional**:
- `createStepForward()` - Creates distance and angle options (12 options)

**Evasion**:
- `createSlipLeft()` - Minimal energy (0.03), maximum safety (0.05 exposure)

**Deflection**:
- `createParryLeft()` - 15 follow-up options, 0.02 exposure risk

**Offensive**:
- `createStraightStrike()` - Targets: nose, throat, solar plexus, eyes
- `createLowKick()` - Targets: thigh, knee lateral, calf

**Each move specifies**:
- General category (moveType)
- Specific sub-category
- Viable targets (vulnerability zones)
- Options created
- Exposure risk

### 6. Terminology Change: "Legal" → "Viable"

**Rationale**: "Legal" implies sport rules. This is a self-defense research engine.

**Changed everywhere**:
- `legalMoves()` → `viableMoves()` - physics-based, not rule-based
- Comments updated to reflect "viable = physically possible given constraints"
- Database comments updated

## How It All Works Together

### Move Selection Flow

```
1. Get all viable moves (physics-based constraints)
   └─ src/moves.nim: viableMoves()

2. For each viable move, score tactically
   ├─ src/tactical.nim: scoreMoveTactically()
   ├─ Calculate target effectiveness
   │  └─ src/vulnerabilities.nim: calculateReachability()
   ├─ Calculate option advantage (tactical liquidity)
   └─ Combine scores with exposure and energy factors

3. Build action sequence (ply)
   ├─ Check time budget (0.6s max)
   ├─ Check limb conflicts
   ├─ Check move type combinations ← NEW
   │  └─ src/moves.nim: canCombineMoveTypes()
   └─ Add moves until time exhausted or no compatible moves

4. Apply sequence to state
   └─ Update biomechanics, momentum, damage, balance
```

### Example Ply Combination

**Scenario**: Defending against haymaker at close range (0.4m)

**Viable Moves Selected**:
1. **Slip Left** (mtEvasion)
   - Time: 0.15s
   - Energy: 0.03
   - Limbs: {} (none)
   - Exposure: 0.05
   - Options created: 8

2. **Parry Left** (mtDeflection)
   - Time: 0.12s
   - Energy: 0.04
   - Limbs: {LeftArm}
   - Exposure: 0.02
   - Options created: 15

3. **Straight Strike to Throat** (mtOffensive → mcStraightStrike)
   - Time: 0.18s
   - Energy: 0.12
   - Limbs: {RightArm}
   - Targets: [vzThroat]
   - Target score: VERY HIGH (close range, low force req, extreme compliance)
   - Exposure: 0.25
   - Options created: 10

**Total Ply**:
- Time: 0.45s (within 0.6s budget) ✓
- Limbs: {LeftArm, RightArm} (no conflicts) ✓
- Move types: mtEvasion(1) + mtDeflection(1) + mtOffensive(1) ✓
- Total exposure: Mitigated by evasion/deflection
- Result: Efficient, safe, high-compliance finish

## Integration with Design Documents

This implementation directly supports your three design philosophies:

### 1. Biomechanical Efficiency
- Vulnerability system uses actual force requirements (Newtons)
- Deflection moves use minimal force (parry = 5% energy vs blocking)
- Energy efficiency factored into scoring

### 2. Movement Library Optimization
- General categories replace martial art dogma
- Selection based on physics (force/compliance ratios)
- Each move analyzed for energy cost, exposure risk, options created

### 3. Tactical Liquidity
- Option count tracked per move
- Position quality = option advantage ratio
- Moves scored by: `(Your Options × Position Quality) / (Opponent Options × Recovery Time)`
- Golden positions (45° angle, underhook, etc.) create 3-5× option advantage

## Next Steps

### Immediate (to compile)
- Install Nim compiler
- Fix any import errors
- Test compilation

### Short-term
1. Expand general moves library to 30-40 core moves
2. Add more vulnerability zones (currently 28, could add nerve points)
3. Implement option tree visualization
4. Add kuzushi (8-direction balance) tracking

### Medium-term
1. Use tactical scoring in simulator (currently random selection)
2. Implement style profiles with biomechanical biases
3. Add backward propagation with option-weighted values
4. Create move effectiveness reports

### Long-term
1. Machine learning on option advantage
2. Automatic discovery of optimal combinations
3. Interactive state explorer with option visualization
4. Human correction interface for unknown states

## Files Modified/Created

**New Files**:
- `src/vulnerabilities.nim` - Complete vulnerability database
- `src/tactical.nim` - Tactical decision-making
- `src/general_moves.nim` - General move library
- `VULNERABILITY_SYSTEM.md` - This document

**Modified Files**:
- `src/fight_types.nim` - Added MoveType, updated Move object, renamed stances
- `src/moves.nim` - Renamed legalMoves→viableMoves, added combination rules
- `src/simulator.nim` - Updated to use viableMoves, fixed stance enums
- `src/constraints.nim` - Fixed stance and category enums
- `src/state_storage.nim` - Updated comments (legal→viable)

## Summary

You now have:
- ✅ Complete vulnerability targeting system with 28 body zones
- ✅ General move categories (not martial-art-specific)
- ✅ Ply combination rules (can mix categories realistically)
- ✅ Tactical scoring based on target quality and options
- ✅ Tactical liquidity calculation (option advantage)
- ✅ Reachability and exposure calculations
- ✅ Force-based target selection (prefers low-force in tight spots)
- ✅ Terminology aligned with research purpose (viable not legal)

The simulation can now:
1. Calculate which body parts are reachable from any position
2. Score targets by force required vs compliance gained
3. Combine multiple move types in realistic sequences per ply
4. Prefer efficient techniques that maximize options while minimizing exposure
5. Select moves based on physics and biomechanics, not tradition
